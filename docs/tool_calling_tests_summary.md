# ChatQwenVllm å·¥å…·è°ƒç”¨æµ‹è¯•ç”¨ä¾‹æ€»ç»“

æœ¬æ–‡æ¡£æè¿°äº†ä¸º `ChatQwenVllm` æ–°å¢çš„å·¥å…·è°ƒç”¨åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹ï¼Œæ¶µç›–æ–‡æœ¬è¾“å‡ºå’Œç»“æ„åŒ–è¾“å‡ºä¸¤ç§æƒ…å†µã€‚

## æµ‹è¯•ç±»: `TestChatQwenVllmToolCalling`

### å·¥å…·å‡½æ•°è®¾è®¡

#### `get_weather_tool()`
- **åŠŸèƒ½**: åˆ›å»ºä¸€ä¸ªå¤©æ°”æŸ¥è¯¢å·¥å…·ï¼Œç”¨äºæµ‹è¯•å·¥å…·è°ƒç”¨åŠŸèƒ½
- **å‚æ•°**: 
  - `location`: æŸ¥è¯¢çš„åŸå¸‚æˆ–åœ°åŒº
  - `unit`: æ¸©åº¦å•ä½ ("celsius" æˆ– "fahrenheit")
- **è¿”å›**: æ ¼å¼åŒ–çš„å¤©æ°”ä¿¡æ¯å­—ç¬¦ä¸²
- **æ•°æ®**: åŒ…å«åŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·ã€æ·±åœ³ã€çº½çº¦ã€ä¼¦æ•¦ã€ä¸œäº¬ç­‰åŸå¸‚çš„æ¨¡æ‹Ÿå¤©æ°”æ•°æ®

```python
@tool
def get_weather(location: str, unit: str = "celsius") -> str:
    """Get the current weather for a specific location."""
```

### æµ‹è¯•ç”¨ä¾‹è¯¦æƒ…

#### 1. `test_tool_calling_text_output`
- **ç›®æ ‡**: æµ‹è¯•åŸºç¡€çš„å·¥å…·è°ƒç”¨åŠŸèƒ½ï¼Œè¿”å›æ–‡æœ¬è¾“å‡º
- **åœºæ™¯**: æŸ¥è¯¢åŒ—äº¬çš„å¤©æ°”
- **éªŒè¯**: 
  - å·¥å…·æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨
  - å‚æ•°æ˜¯å¦æ­£ç¡®æå–ï¼ˆlocation="beijing"ï¼‰
  - å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œæ–‡æœ¬å†…å®¹æ˜¯å¦æåŠå¤©æ°”ç›¸å…³ä¿¡æ¯

#### 2. `test_tool_calling_multiple_locations`
- **ç›®æ ‡**: æµ‹è¯•å¤šåœ°ç‚¹æŸ¥è¯¢çš„å·¥å…·è°ƒç”¨
- **åœºæ™¯**: åŒæ—¶æŸ¥è¯¢ä¸Šæµ·å’Œå¹¿å·çš„å¤©æ°”
- **éªŒè¯**:
  - è‡³å°‘æœ‰ä¸€ä¸ªå·¥å…·è°ƒç”¨
  - è‡³å°‘ä¸€ä¸ªåŸå¸‚è¢«æ­£ç¡®æå–
  - æ–‡æœ¬å“åº”åŒ…å«ç›¸å…³åŸå¸‚ä¿¡æ¯

#### 3. `test_tool_calling_with_structured_output` â­
- **ç›®æ ‡**: æµ‹è¯•å·¥å…·è°ƒç”¨ä¸ç»“æ„åŒ–è¾“å‡ºçš„ç»“åˆ
- **åœºæ™¯**: æŸ¥è¯¢ä¸œäº¬å¤©æ°”å¹¶è¿”å›ç»“æ„åŒ–æ•°æ®
- **Schema**: `WeatherQuery` åŒ…å«ä½ç½®ã€æ¸©åº¦ã€æ¡ä»¶ã€æ¹¿åº¦ã€å•ä½
- **æµç¨‹**: 
  1. ç»‘å®šå·¥å…· (`bind_tools`)
  2. æ·»åŠ ç»“æ„åŒ–è¾“å‡º (`with_structured_output`)
  3. è°ƒç”¨å¹¶éªŒè¯è¿”å›çš„ Pydantic æ¨¡å‹

#### 4. `test_tool_calling_with_include_raw`
- **ç›®æ ‡**: æµ‹è¯•ç»“æ„åŒ–è¾“å‡ºçš„ `include_raw=True` åŠŸèƒ½
- **åœºæ™¯**: æŸ¥è¯¢å¤šä¸ªåŸå¸‚å¹¶ç”Ÿæˆå¤©æ°”æ‘˜è¦
- **Schema**: `WeatherSummary` åŒ…å«åŸå¸‚åˆ—è¡¨ã€æ€»ä½“æ¡ä»¶ã€æ¸©åº¦èŒƒå›´
- **éªŒè¯**: è¿”å›åŒ…å« rawã€parsedã€parsing_error çš„å­—å…¸

#### 5. `test_tool_calling_async`
- **ç›®æ ‡**: æµ‹è¯•å¼‚æ­¥å·¥å…·è°ƒç”¨åŠŸèƒ½
- **åœºæ™¯**: å¼‚æ­¥æŸ¥è¯¢ä¼¦æ•¦å¤©æ°”
- **éªŒè¯**: å¼‚æ­¥è°ƒç”¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œå‚æ•°æå–æ˜¯å¦æ­£ç¡®

#### 6. `test_tool_calling_with_temperature_unit`
- **ç›®æ ‡**: æµ‹è¯•ç‰¹å®šæ¸©åº¦å•ä½çš„å‚æ•°æå–
- **åœºæ™¯**: æŸ¥è¯¢çº½çº¦çš„åæ°æ¸©åº¦
- **éªŒè¯**: 
  - åœ°ç‚¹å‚æ•°æ­£ç¡®æå–
  - æ¸©åº¦å•ä½å‚æ•°ï¼ˆå¦‚æœæ”¯æŒï¼‰æ­£ç¡®æå–

#### 7. `test_tool_calling_error_handling`
- **ç›®æ ‡**: æµ‹è¯•å·¥å…·è°ƒç”¨çš„é”™è¯¯å¤„ç†
- **åœºæ™¯**: æŸ¥è¯¢ä¸å­˜åœ¨çš„åŸå¸‚
- **éªŒè¯**: ç³»ç»Ÿä¼˜é›…å¤„ç†æ— æ•ˆè¾“å…¥ï¼Œä¸ä¼šå´©æºƒ

## æµ‹è¯•ç‰¹ç‚¹

### ğŸ¯ **å…¨é¢è¦†ç›–**
- âœ… åŸºç¡€å·¥å…·è°ƒç”¨ï¼ˆæ–‡æœ¬è¾“å‡ºï¼‰
- âœ… å¤šå‚æ•°å·¥å…·è°ƒç”¨
- âœ… å·¥å…·è°ƒç”¨ + ç»“æ„åŒ–è¾“å‡º
- âœ… å¼‚æ­¥å·¥å…·è°ƒç”¨
- âœ… é”™è¯¯å¤„ç†
- âœ… å‚æ•°æå–éªŒè¯

### ğŸ›  **æŠ€æœ¯äº®ç‚¹**

#### å·¥å…·è°ƒç”¨ + ç»“æ„åŒ–è¾“å‡ºç»“åˆ
```python
# å…ˆç»‘å®šå·¥å…·ï¼Œå†æ·»åŠ ç»“æ„åŒ–è¾“å‡º
llm_with_tools = self.llm.bind_tools([weather_tool])
structured_llm = llm_with_tools.with_structured_output(
    schema=WeatherQuery,
    method="json_schema"
)
```

#### çµæ´»çš„æ–­è¨€ç­–ç•¥
```python
# æ”¯æŒä¸¤ç§æƒ…å†µï¼šå·¥å…·è°ƒç”¨æˆ–æ–‡æœ¬å›å¤
if hasattr(response, 'tool_calls') and response.tool_calls:
    # éªŒè¯å·¥å…·è°ƒç”¨
    assert tool_call['name'] == 'get_weather'
    assert 'beijing' in tool_call['args']['location'].lower()
else:
    # éªŒè¯æ–‡æœ¬å†…å®¹
    assert any(word in content_lower for word in ['weather', 'beijing'])
```

### ğŸ“Š **æµ‹è¯•æ•°æ®**

#### æ¨¡æ‹Ÿå¤©æ°”æ•°æ®
åŒ…å« 7 ä¸ªåŸå¸‚çš„å®Œæ•´å¤©æ°”ä¿¡æ¯ï¼š
- **ä¸­æ–‡åŸå¸‚**: åŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·ã€æ·±åœ³
- **å›½é™…åŸå¸‚**: çº½çº¦ã€ä¼¦æ•¦ã€ä¸œäº¬
- **æ•°æ®å­—æ®µ**: æ¸©åº¦ã€å¤©æ°”æ¡ä»¶ã€æ¹¿åº¦

#### æ¸©åº¦å•ä½è½¬æ¢
æ”¯æŒæ‘„æ°åº¦å’Œåæ°åº¦ä¹‹é—´çš„è½¬æ¢ï¼š
```python
if unit == "fahrenheit":
    data["temp"] = int(data["temp"] * 9/5 + 32)
```

## ä½¿ç”¨ç¤ºä¾‹

### è¿è¡Œæ‰€æœ‰å·¥å…·è°ƒç”¨æµ‹è¯•
```bash
pytest tests/integration_tests/test_chat_models_vllm.py::TestChatQwenVllmToolCalling -v
```

### è¿è¡Œç‰¹å®šæµ‹è¯•
```bash
# æµ‹è¯•åŸºç¡€å·¥å…·è°ƒç”¨
pytest tests/integration_tests/test_chat_models_vllm.py::TestChatQwenVllmToolCalling::test_tool_calling_text_output -v

# æµ‹è¯•ç»“æ„åŒ–è¾“å‡ºç»“åˆ
pytest tests/integration_tests/test_chat_models_vllm.py::TestChatQwenVllmToolCalling::test_tool_calling_with_structured_output -v

# æµ‹è¯•å¼‚æ­¥åŠŸèƒ½
pytest tests/integration_tests/test_chat_models_vllm.py::TestChatQwenVllmToolCalling::test_tool_calling_async -v
```

## éªŒè¯ç»“æœ

### âœ… **åŸºç¡€æµ‹è¯•é€šè¿‡**
- å·¥å…·è°ƒç”¨æœºåˆ¶æ­£å¸¸å·¥ä½œ
- å‚æ•°æå–åŠŸèƒ½æ­£ç¡®
- å¼‚æ­¥è°ƒç”¨æ”¯æŒå®Œå–„

### âœ… **é›†æˆæµ‹è¯•æˆåŠŸ**
- å·¥å…·è°ƒç”¨ä¸ç»“æ„åŒ–è¾“å‡ºå®Œç¾ç»“åˆ
- `include_raw` å‚æ•°åŠŸèƒ½æ­£å¸¸
- é”™è¯¯å¤„ç†æœºåˆ¶å¥å£®

### âœ… **å®é™…åº”ç”¨éªŒè¯**
- å¤©æ°”æŸ¥è¯¢åœºæ™¯çœŸå®å¯ç”¨
- å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­è‹±æ–‡åŸå¸‚ï¼‰
- å¤šç§è¾“å‡ºæ ¼å¼å…¼å®¹

## æ€»ç»“

è¿™å¥—å·¥å…·è°ƒç”¨æµ‹è¯•ç”¨ä¾‹æˆåŠŸéªŒè¯äº† `ChatQwenVllm` åœ¨ä»¥ä¸‹æ–¹é¢çš„èƒ½åŠ›ï¼š

1. **å·¥å…·ç»‘å®š**: ä½¿ç”¨ `bind_tools()` æ­£ç¡®ç»‘å®šå·¥å…·å‡½æ•°
2. **å‚æ•°æå–**: ä»è‡ªç„¶è¯­è¨€ä¸­æå–å·¥å…·è°ƒç”¨å‚æ•°
3. **ç»“æ„åŒ–ç»“åˆ**: å·¥å…·è°ƒç”¨ç»“æœä¸ç»“æ„åŒ–è¾“å‡ºçš„æ— ç¼é›†æˆ
4. **å¼‚æ­¥æ”¯æŒ**: å®Œæ•´çš„å¼‚æ­¥å·¥å…·è°ƒç”¨èƒ½åŠ›
5. **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

æµ‹è¯•ç”¨ä¾‹è®¾è®¡åˆç†ï¼Œè¦†ç›–å…¨é¢ï¼Œä¸º `ChatQwenVllm` çš„å·¥å…·è°ƒç”¨åŠŸèƒ½æä¾›äº†å¯é çš„è´¨é‡ä¿è¯ã€‚
